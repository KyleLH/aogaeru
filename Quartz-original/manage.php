<center><?php//============================================================//Filename : manage.php//Variables ://  Local://      $info - Databse record for this website.//      $uname - Bu username of website owner.//  $_SESSION://      'usertype' - The type of user currently logged in.//      'name' - Name of logged in user.//      'email' - Email of logged in user.//      'buid' - BUID of logged in user.////============================================================	include 'dbvars.php';	$thisfilename = "manage.php";	//print($thisfilename."@0 _SESSION['email']: ".$_SESSION['email']."<br>");	//die("after ".$thisfilename."@0");	// Get username	$uname = substr($_SESSION['email'],0,strlen($_SESSION['email'])-7);	// Connect to DB server	//print("manage.php@1: about to connect to database server<br>");	mysql_connect($serverurl, $adminname, $adminp) or die(mysql_error());	//print("manage.php@1.1: connected to database server; about to select database<br>");	mysql_select_db($dbname) or die(mysql_error());	//print("manage.php@1.2: selected database<br>");	// Select user information from Database	$check = mysql_query("SELECT * FROM loginSet WHERE email = '". $uname. "@bu.edu'")or die(mysql_error());	$info = mysql_fetch_array( $check );	//user is approved then...	$approved = $info['isApproved'];	// print("manage.php@2.0: apparently got login info for uname=[".$uname."], ".	// 	"email=[".$_SESSION['email']."]; is approved? [".$approved."]<br>");	// If the user is a level 2 user (admin)	if ($_SESSION['usertype'] == 2) { // [LOGIN.0006]		// If the admin is adding a user		if (isset($_POST['adduser']) && $_POST['adduser']) {			mysql_query("INSERT INTO loginSet (email) VALUES ('".$_POST['email']."')");		}		// If the admin is approving a user send the user an email		if (isset($_POST['appuser']) && $_POST['appuser']) {			$to = $_POST['user'];			$subject = "CS Website Approval";			$body = "Hi,\n\nClick on the link below to approve your CS account.\n\n".$rootpath."approve.php?id=".md5($_POST['user'])."\n\n";			$headers = "From: admin@cs.bu.edu\r\n"."X-Mailer: php";			if ($canmail) {				mail($to, $subject, $body, $headers);			} else {				print($body);			}			mysql_query("UPDATE loginSet SET hash = '".md5($_POST['user'])."' WHERE email = '".$_POST['user']."'");		}	// If the admin is deauthorizing a user	if (isset($_POST['deauthorizeuser']) && $_POST['deauthorizeuser']) { // [MNG.0001], [MNG.0011]		mysql_query("UPDATE loginSet SET isApproved = 0 WHERE email = '".$_POST['user']."'"); // [MNG.0011]		mysql_query("UPDATE loginSet SET hash = '' WHERE email = '".$_POST['user']."'");		mysql_query("UPDATE webData SET isonline = 0 WHERE email = '".$_POST['user']."'");	}	// If the admin is deleting a user	if (isset($_POST['deluser']) && $_POST['deluser']) {		mysql_query("DELETE FROM loginSet WHERE email = '".$_POST['user']."'");		mysql_query("DELETE FROM nLogin WHERE email = '".$_POST['user']."'");		mysql_query("DELETE FROM webData WHERE email = '".$_POST['user']."'");	}	// Get Website data	$check = mysql_query("SELECT * FROM loginSet")or die(mysql_error());}//If the user is a level 1 user (professor)//----------------------------- Content Editing -----------------------------if ($_SESSION['usertype'] == 1) {	//If the user has an approved account	 if ($approved) {		// Get Website data		$check = mysql_query("SELECT * FROM webData WHERE email = '". $uname. "@bu.edu'")or die(mysql_error());		$info = mysql_fetch_array( $check );		// If website record doesnt exist then create one		if (!$info) { // [MNG.0009]			mysql_query("INSERT INTO webData (email) VALUES ('". $uname. "@bu.edu')");			$check = mysql_query("SELECT * FROM webData WHERE email = '". $uname. "@bu.edu'")or die(mysql_error());			$info = mysql_fetch_array( $check );		}		// If someone is updating the online/offline status of the website		if (isset($_POST['websettings']) && $_POST['websettings']) { // [MNG.0008]			if ($info) {				mysql_query("UPDATE webData SET isonline = ".$_POST['isonline']." WHERE email = '" . $uname. "@bu.edu'");				$info['isonline'] = $_POST['isonline'];			} else {				die('Internal Server Error : Code 101');			}		}		//If someone is uploading a picture		if (isset($_POST['upload']) && $_POST['upload']) { // [PHOTO.0002]			$target_path = $uname."/picture.jpg"; // [PHOTO.0001]			@unlink($target_path); // '@' prevents any error messages, such as 'the file does not exist'			/*				This function checks to ensure that the file designated by filename is a		        valid upload file (meaning that it was uploaded via PHP's HTTP		        POST upload mechanism). If the file is valid, it will be moved to		        the filename given by destination.		    */			if(move_uploaded_file($_FILES['uploadedfile']['tmp_name'], $target_path)) {				echo "<Script language='javascript'>alert ('Upload succeeded.')</script>";			} else {				echo "<Script language='javascript'>alert ('Upload failed.')</script>";			}		}		// If Someone is uploading general information		//combining geninfo and savebio into saveall		//it would be nice to not right changes to the database if nothing changed.		//ill decompose these into methods once i get the chance.		if (isset($_POST['saveall']) && $_POST['saveall']) { // [MNG.0003]			if ($info) {				//general info				$info['name'] = $_POST['displayName'];				$info['phone'] = $_POST['tel'];				$info['fax'] = $_POST['fax'];				$info['ofhours'] = $_POST['ohrs'];				$info['jobtitle'] = $_POST['job'];				$info['office'] = $_POST['address'];				mysql_query("UPDATE webData SET name = '".$info['name']."' WHERE email = '" . $uname. "@bu.edu'");				mysql_query("UPDATE webData SET phone = '".$info['phone']."' WHERE email = '" . $uname. "@bu.edu'");				mysql_query("UPDATE webData SET fax = '".$info['fax']."' WHERE email = '" . $uname. "@bu.edu'");				mysql_query("UPDATE webData SET ofhours = '".$info['ofhours']."' WHERE email = '" . $uname. "@bu.edu'");				mysql_query("UPDATE webData SET jobtitle = '".$info['jobtitle']."' WHERE email = '" . $uname. "@bu.edu'");				mysql_query("UPDATE webData SET office = '".$info['office']."' WHERE email = '" . $uname. "@bu.edu'");				// [MNG.0014]				//bio				$info['bio'] = substr($_POST['bio'],0,1480); // [MNG.0005]				mysql_query("UPDATE webData SET bio = '".$info['bio']."' WHERE email = '" . $uname. "@bu.edu'");				//teach				if($_POST['name'] != "" || $_POST['link'] != "" || $_POST['desc'] != "") {					$info['teaching'] = $info['teaching'].$_POST['name'].";".$_POST['link']."; - ".$_POST['desc'].";";					mysql_query("UPDATE webData SET teaching = '".$info['teaching']."' WHERE email = '" . $uname. "@bu.edu'");				}				//research				if ( isset($_POST['research']) ) {					$info['researchsum'] = substr($_POST['research'],0,1480);					mysql_query("UPDATE webData SET researchsum = '".$info['researchsum']."' WHERE email = '" . $uname. "@bu.edu'");				}				//awards				if ( isset($_POST['awardsEnable']) ) {					file_put_contents($uname."/awards.html",$_POST['awards']);					$info['awards'] = $_POST['awardsEnable']; // [MNG.0006]					mysql_query("UPDATE webData SET awards = '".$info['awards']."' WHERE email = '" . $uname. "@bu.edu'");				}				//projects				if ( isset($_POST['projectsEnable']) ) {					file_put_contents($uname."/projects.html",$_POST['projects']);					$info['projects'] = $_POST['projectsEnable']; // [MNG.0006]					mysql_query("UPDATE webData SET projects = '".$info['projects']."' WHERE email = '" . $uname. "@bu.edu'");				}				//If someone updated their students information				if ( isset($_POST['studentsEnable']) ) {					file_put_contents($uname."/students.html",$_POST['students']);					$info['students'] = $_POST['studentsEnable']; // [MNG.0006]					mysql_query("UPDATE webData SET students = '".$info['students']."' WHERE email = '" . $uname. "@bu.edu'");				}				// If someone updated their personal information				if ( isset($_POST['personalEnable']) ) {					file_put_contents($uname."/personal.html",$_POST['personal']);					$info['personal'] = $_POST['personalEnable']; // [MNG.0006]					mysql_query("UPDATE webData SET personal = '".$info['personal']."' WHERE email = '" . $uname. "@bu.edu'");				}			}//end if($info)		}//end if (isset($_POST['saveall']) && $_POST['saveall'])		if (isset($_POST['clearTeach']) && $_POST['clearTeach']) { // [MNG.0012], [MNG.00013]			if ($info) {				$info['teaching'] = ""; // [MNG.0013]				mysql_query("UPDATE webData SET teaching = '' WHERE email = '" . $uname. "@bu.edu'");			} else {				die('Internal Server Error : Code 101');			}		}//end if (isset($_POST['clearTeach']) && $_POST['clearTeach'])/*		if (isset($_POST['geninfo']) && $_POST['geninfo'])		{			if ($info)			{				$info['name'] = $_POST['name'];				$info['phone'] = $_POST['tel'];				$info['fax'] = $_POST['fax'];				$info['ofhours'] = $_POST['ohrs'];				$info['jobtitle'] = $_POST['job'];				$info['office'] = $_POST['address'];				mysql_query("UPDATE webData SET name = '".$info['name']."' WHERE email = '" . $uname. "@bu.edu'");				mysql_query("UPDATE webData SET phone = '".$info['phone']."' WHERE email = '" . $uname. "@bu.edu'");				mysql_query("UPDATE webData SET fax = '".$info['fax']."' WHERE email = '" . $uname. "@bu.edu'");				mysql_query("UPDATE webData SET ofhours = '".$info['ofhours']."' WHERE email = '" . $uname. "@bu.edu'");				mysql_query("UPDATE webData SET jobtitle = '".$info['jobtitle']."' WHERE email = '" . $uname. "@bu.edu'");				mysql_query("UPDATE webData SET office = '".$info['office']."' WHERE email = '" . $uname. "@bu.edu'");			}			else			{				die('Internal Server Error : Code 101');			}		}		// If someone is updating their biography		if (isset($_POST['savebio']) && $_POST['savebio'])		{			if ($info)			{				$info['bio'] = substr($_POST['bio'],0,1480);				mysql_query("UPDATE webData SET bio = '".$info['bio']."' WHERE email = '" . $uname. "@bu.edu'");			}			else			{				die('Internal Server Error : Code 101');			}		}		// If someone is adding a class to their class list		if (isset($_POST['teach']) && $_POST['teach'])		{			if ($info)			{				$info['teaching'] = $info['teaching'].$_POST['name'].";".$_POST['link']."; - ".$_POST['desc'].";";				mysql_query("UPDATE webData SET teaching = '".$info['teaching']."' WHERE email = '" . $uname. "@bu.edu'");			}			else			{				die('Internal Server Error : Code 101');			}		}		// If someone is deleting all their classes		if (isset($_POST['clearteach']) && $_POST['clearteach'])		{			if ($info)			{				$info['teaching'] = "";				mysql_query("UPDATE webData SET teaching = '' WHERE email = '" . $uname. "@bu.edu'");			}			else			{				die('Internal Server Error : Code 101');			}		}		// If someone updated their research summary		if (isset($_POST['saveres']) && $_POST['saveres'])		{			if ($info)			{				$info['researchsum'] = substr($_POST['res'],0,1480);				mysql_query("UPDATE webData SET researchsum = '".$info['researchsum']."' WHERE email = '" . $uname. "@bu.edu'");			}			else			{				die('Internal Server Error : Code 101');			}		}		//If someone updated their awards information		if (isset($_POST['saveawards']) && $_POST['saveawards'])		{			if ($info)			{				file_put_contents($uname."/awards.html",$_POST['res']);				$info['awards'] = $_POST['enable'];				mysql_query("UPDATE webData SET awards = '".$info['awards']."' WHERE email = '" . $uname. "@bu.edu'");			}			else			{				die('Internal Server Error : Code 101');			}		}		// If someone updated their projects information		if (isset($_POST['saveprojects']) && $_POST['saveprojects'])		{			if ($info)			{				file_put_contents($uname."/projects.html",$_POST['res']);				$info['projects'] = $_POST['enable'];				mysql_query("UPDATE webData SET projects = '".$info['projects']."' WHERE email = '" . $uname. "@bu.edu'");			}			else			{				die('Internal Server Error : Code 101');			}		}		//If someone updated their students information		if (isset($_POST['savestudents']) && $_POST['savestudents'])		{			if ($info)			{				file_put_contents($uname."/students.html",$_POST['res']);				$info['students'] = $_POST['enable'];				mysql_query("UPDATE webData SET students = '".$info['students']."' WHERE email = '" . $uname. "@bu.edu'");			}			else			{				die('Internal Server Error : Code 101');			}		}		// If someone updated their personal information		if (isset($_POST['savepersonal']) && $_POST['savepersonal'])		{			if ($info)			{				file_put_contents($uname."/personal.html",$_POST['res']);				$info['personal'] = $_POST['enable'];				mysql_query("UPDATE webData SET personal = '".$info['personal']."' WHERE email = '" . $uname. "@bu.edu'");			}			else			{				die('Internal Server Error : Code 101');			}		}		*/	}}?><script language = "Javascript">/*** DHTML textbox character counter script. Courtesy of SmartWebby.com (http://www.smartwebby.com/dhtml/)*/maxL=1500;var bName = navigator.appName;function taLimit(taObj) {		if (taObj.value.length==maxL) {			return false;		}		return true;}function taCount(taObj,Cnt) {		objCnt=createObject(Cnt);		objVal=taObj.value;		if (objVal.length>maxL) {			objVal=objVal.substring(0,maxL);		}		if (objCnt) {			if(bName == "Netscape") {				objCnt.textContent=maxL-objVal.length;			} else {				objCnt.innerText=maxL-objVal.length;			}		}		return true;}function createObject(objId) {		if (document.getElementById) {			return document.getElementById(objId);		} else if (document.layers) {			return eval("document." + objId);		} else if (document.all) {			return eval("document.all." + objId);		} else {			return eval("document." + objId);		}}</script><div style="position: relative; <?php if (strstr($_SERVER['HTTP_USER_AGENT'],"Mozilla") != "") echo 'top:-15px;'; ?> width: 945px; height:auto; background: url('images/Body.jpg'); text-align:left;"><div style="position: relative; left:30px; width:880px; top:10px; font-size: 11px; font-family:Tahoma;"><?phpif ($approved) {	if ($_SESSION['usertype'] == 1) {?><span style="font-size: 16px;"><b>Website Management Panel</b></span><hr width='880px'><span style="text-align:right;">Welcome, <?php echo $_SESSION['name']; ?>!</span><hr width='880px'><h3>Website Settings:</h3><form action="" method="POST">Online : <input type="radio" name="isonline" value="1" <?php if ($info && $info['isonline']) echo 'checked' ?>/>&nbsp;&nbsp;Offline:<input type="radio" name="isonline" value="0" <?php if (!$info || !$info['isonline']) echo 'checked' ?> /><br><br><input type="submit" value="Apply" name="websettings" /></form><hr width='880px'><h3>Picture:</h3><table style="border-style:solid; border-width:1px"><tr><td><img src="<?php echo $uname; ?>/picture.jpg" width="60px" height="90px"/></td></tr></table><br>Your picture should be approximately 230x350 pixels.<br><br> <!-- [PHOTO.0003] --><form enctype="multipart/form-data" action="" method="POST"><input type="hidden" name="MAX_FILE_SIZE" value="400000" />Choose a picture to upload:<input name="uploadedfile" type="file" size="64" /> <br /><br><input type="submit" value="Upload Picture" name="upload"/></form><!-- Combining the geninfo and savebio forms --> <!-- [MNG.0003] --><hr width='880px'><h3>General Information:</h3>Tip : Use HTML tags for special formatting.<br><br><form action="" method="POST">Display Name : <input type="text" name="displayName" value="<?php echo $info['name'] ?>" size="40" /><br><br>Job Title : <input type="text" name="job" value="<?php echo $info['jobtitle'] ?>" size="40" /><br><br>Office Address : <input type="text" name="address" value="<?php echo $info['office'] ?>" size="40" /><br><br>Tel : <input type="text" name="tel" value="<?php echo $info['phone'] ?>" size="40" /><br><br>Fax : <input type="text" name="fax" value="<?php echo $info['fax'] ?>" size="40" /><br><br>Office hours : <input type="text" name="ohrs" value="<?php echo $info['ofhours'] ?>" size="40" />&nbsp;&nbsp;(Use this format [DAY TT:TT - TT:TT])<br><br><input type="submit" value="Save" name="saveall" /><hr width='880px'><h3>Short Biography:</h3>Tip : Use HTML tags for special formatting.<br><br><textarea onKeyPress="return taLimit(this)" onKeyUp="return taCount(this,'myCounter')" name="bio" rows=7 wrap="physical" cols=100><?php echo $info['bio'];?></textarea><br><br>You have <B><SPAN id=myCounter>1500</SPAN></B> characters remaining.</font><br><br><input type="submit" value="Save" name="saveall" /><hr width='880px'><h3>Teaching:</h3><?php// Print out course list$clist = $info['teaching'];while ($clist != "") {$title = substr($clist,0,strpos($clist,";"));$clist = substr($clist,strpos($clist,";")+1);$link = substr($clist,0,strpos($clist,";"));$clist = substr($clist,strpos($clist,";")+1);$desc = substr($clist,0,strpos($clist,";"));$clist = substr($clist,strpos($clist,";")+1);echo $title.$desc."<br><br>";}?>Course Name : <input type="text" name="name" value="" size="100" /><br><br>Course Website Link : <input type="text" name="link" value="" size="100" /><br><br>Short Description : <input type="text" name="desc" value="" size="100" /><br><br><input type="submit" value="Add New" name="saveall" /> <!-- [MNG.0007] -->&nbsp;&nbsp;<input type="submit" value="Delete All" name="clearTeach" /> <!-- [MNG.0008], [MNG.0012], [MNG.0013] --><hr width='880px'><h3>Research:</h3>Research Summary : <br>( Tip : Use HTML tags for special formatting. )<br><br><textarea onKeyPress="return taLimit(this)" onKeyUp="return taCount(this,'myCounter2')" name="research" rows=7 wrap="physical" cols=100><?php echo $info['researchsum'];?></textarea><br><br>You have <B><SPAN id=myCounter2>1500</SPAN></B> characters remaining.</font><br><br><input type="submit" value="Save" name="saveall" /><hr width='880px'><h3>Awards:</h3>( Tip : Use HTML tags for special formatting. )<br><br><textarea name="awards" rows=7 wrap="physical" cols=100><?php echo file_get_contents($uname."/awards.html");?></textarea><br><br>Enabled : <input type="checkbox" name="awardsEnable" value="1" <?php if ($info['awards'] == "1") echo "checked"; ?> /> <!-- [MNG.0006] --><br><br><input type="submit" value="Save" name="saveall" /><hr width='880px'><h3>Projects:</h3>( Tip : Use HTML tags for special formatting. )<br><br><textarea name="projects" rows=7 wrap="physical" cols=100><?php echo file_get_contents($uname."/projects.html");?></textarea><br><br>Enabled : <input type="checkbox" name="projectsEnable" value="1" <?php if ($info['projects'] == "1") echo "checked"; ?>  /> <!-- [MNG.0006] --><br><br><input type="submit" value="Save" name="saveall" /><hr width='880px'><h3>Students:</h3>( Tip : Use HTML tags for special formatting. )<br><br><textarea name="students" rows=7 wrap="physical" cols=100><?php echo file_get_contents($uname."/students.html");?></textarea><br><br>Enabled : <input type="checkbox" name="studentsEnable" value="1"  <?php if ($info['students'] == "1") echo "checked"; ?> /> <!-- [MNG.0006] --><br><br><input type="submit" value="Save" name="saveall" /><hr width='880px'><h3>Personal:</h3>( Tip : Use HTML tags for special formatting. )<br><br><textarea name="personal" rows=7 wrap="physical" cols=100><?php echo file_get_contents($uname."/personal.html");?></textarea><br><br>Enabled : <input type="checkbox" name="personalEnable" value="1"  <?php if ($info['personal'] == "1") echo "checked"; ?> /> <!-- [MNG.0006] --><br><br><input type="submit" value="Save" name="saveall" /></form><?php}	else if ($_SESSION['usertype'] == 2) //If the user is level 2, an admin...// [MNG.0002], [MNG.0010]{?><span style="font-size: 16px;"><b>User Administration Panel</b></span><br><br><table border="2px"style="font-size: 14px;" cellpadding="5px"><tr><th>User Email</th><th>Created</th><th>Activated</th></tr><?php$info = mysql_fetch_array( $check );                while ($info) // [MNG.0009]                {                    $created = mysql_query("SELECT * FROM nLogin WHERE email ='".$info['email']."'") or die(mysql_error());                    echo "<tr>";                    echo "<td>".$info['email']."</td>";                    $test = mysql_fetch_array( $created );                    echo "<td><form action='' method='POST'><input type='hidden' name='user' value='".$info['email']."' readonly='readonly' /><input type='submit' value='Delete' name='deluser' ";                    if ($test['isactive'] == 2) echo "disabled";                    echo "/></form></td>";                    echo "<td>";                    if ($test && $test['isactive'] != 2)                    {                        if ($info['isApproved'] == 0) // [MNG.0009]                        {                            echo "<form action='' method='POST'><input type='hidden' name='user' value=".$info['email']." readonly='readonly' /><input type='submit' value='Approve' name='appuser' /></form>"; // [MNG.0009]                            if ($info['hash']) echo '(Email sent)'; // [MNG.0009]                        }                        else                        {                            echo "<form action='' method='POST'><input type='hidden' name='user' value=".$info['email']." readonly='readonly' /><input type='submit' value='Deauthorize' name='deauthorize' /></form>"; // [MNG.0011]                        }                    }                    else                    {                        echo "<form><input type='submit' value='Approve' name='appuser' disabled/></form>";                    }                    echo "<td>";                    if ( isset($info['email']) && isset($_POST['user']))                    {                   		echo "<a href=\"mailto:".$info['email']."?subject=CS%20Website%20Approval&body=Hi,\n\nClick%20on%20the%20link%20below%20to%20approve%20your%20CS%20account.\n\n".$rootpath."approve.php?id=".md5($_POST['user'])."\" style=\"color: #686868\">Contact</a>"; // [MNG.0002]					}                    echo "</tr>";                    $info = mysql_fetch_array( $check );                }            ?><tr><td colspan="3"><form action="" method="POST"><input type="text" name="email" value="" size="20" /><input type="submit" value="Add" name="adduser" /></form></td></tr></table><?php}}else{echo "<h3>Your account is not approved by the administrator yet.</h3><br><br>."; // [MNG.0010]}?><br><br>.</div></div><?php//print_r($_POST);?></center>